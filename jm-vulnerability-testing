Map.setOptions("satellite");
var palettes = require('users/gena/packages:palettes');
var globals = require('users/geraezemc/buildingbigdataapp:globals');
var UIfuncs = require('users/geraezemc/buildingbigdataapp:UI-functions');
var cumulativeFlooded = require('users/geraezemc/buildingbigdataapp:globals').cumulativeFlooded;
var HRSL_30m = ee.ImageCollection("projects/sat-io/open-datasets/hrsl/hrslpop");
var palette = palettes.colorbrewer.OrRd[4];

// Load the population count ImageCollection
// Map.addLayer(HRSL_30m, {min: 0, max: 60, palette: 'white,blue,green,red'}, 'Population');

// var clippedHRSL = HRSL_30m.mean().clip(aoi);
// var populationSum = clippedHRSL.reduceRegion({
//   reducer: ee.Reducer.sum(),
//   geometry: aoi,
//   scale: 30,
//   maxPixels: 1e9
// });
// print('Population sum within AOI:', populationSum.getNumber('b1'));

////// Vulnerability Index //////

// Map.addLayer(vulnerabilityIndex, {min: 0, max: 100, palette: palette}, 'Vulnerability Index');

// var meanVulnerability = vulnerabilityIndex.reduceRegion({
//   reducer: ee.Reducer.mean(),
//   geometry: aoi,
//   scale: 30,
//   maxPixels: 1e9
// });
// print('Mean vulnerability index value in Sindh:', meanVulnerability.get('b1'));
  // var vulnerabilityIndexGT0 = vulnerabilityIndex.gt(0);


/// The 2 functions below are needed
// Function to calculate mean vulnerability index for a given AOI ////
var calculateMeanVulnerability = function(aoi) {
  var clippedHRSL = HRSL_30m.mean().clip(aoi);
  var clippedCumulativeFlooded = cumulativeFlooded.clip(aoi);
  var vulnerabilityIndex = clippedHRSL.multiply(clippedCumulativeFlooded);

  var meanVulnerability = vulnerabilityIndex.reduceRegion({
    reducer: ee.Reducer.mean(),
    geometry: aoi.geometry(),
    scale: 30,
    maxPixels: 1e9
  });
  
  var meanValue = meanVulnerability.get('b1');
  var feature = ee.Feature(aoi)
                  .set('mean_vulnerability_index', meanValue);
  return feature;
  
};

// Function to chart the mean vulnerability index for a given AOI
var vulnerability_index_chart = function(aoi) {
  
  var l2_list = aoi.aggregate_array('ADM2_NAME').distinct().getInfo().sort();
  var l2_name = l2_list[0];

  var result = ee.FeatureCollection(l2_list.map(function(l2_name) {
    var roi = aoi.filter(ee.Filter.eq('ADM2_NAME', l2_name)).first();
    var feature = calculateMeanVulnerability(roi);
    return feature;
    
  }));
  
  var sortedResult = result.sort('mean_vulnerability_index', false);
  var top10Result = sortedResult.limit(10);

  var chart = ui.Chart.feature.byFeature(top10Result, 'ADM2_NAME', 'mean_vulnerability_index')
              .setChartType('ColumnChart')
              .setOptions({
                title: 'Mean Vulnerability Index per sub-region',
                hAxis: {title: 'Region (l2)', slantedText: true, slantedTextAngle: 45},
                vAxis: {title: 'Mean Vulnerability Index'},
                legend: {position: 'none'},
                height: 300,
                width: 1000
              });
  return chart;
};

var mapVulnerabilityIndex = function(aoi) {
  
  var clippedCumulativeFlooded = cumulativeFlooded.clip(aoi);
  var clippedHRSL = HRSL_30m.mean().clip(aoi);
  var vulnerabilityIndex = clippedHRSL.multiply(clippedCumulativeFlooded);
  
  var max_value_vulnind = vulnerabilityIndex.reduceRegion(ee.Reducer.max(), aoi).get('b1').getInfo();
  print("Max vulnerabilityIndex" + max_value_vulnind)
  
  // Smoothing ////
  var radius = 400; // Adjust as needed
  var kernel = ee.Kernel.square({
    radius: radius,
    units: 'meters'
  });
  
  var interpolate = function(image) {
    var smoothed = image.focal_mean({kernel: kernel, iterations: 1});
    var filled = image.unmask(smoothed);
    return filled;
  };
  
  var smoothedvulner = interpolate(vulnerabilityIndex).updateMask(interpolate(vulnerabilityIndex).gt(0));
  var maxval = smoothedvulner.reduceRegion({
    reducer: ee.Reducer.max(),
    geometry: aoi,
    scale: 30,
    bestEffort: true
  }).get('b1').getInfo();
  
  var createColorbar = UIfuncs.createColorbar;
  var vuln_colorbar = createColorbar('Vulnerability Index', maxval, 0, palette);
  
  Map.addLayer(smoothedvulner, {min: 0, max: maxval, palette: palette}, 'Smoothed Vulnerability Index');
  Map.add(vuln_colorbar);
  print("Max smoothed vuln" + maxval)

};

// var aoi = globals.gaul_l2.filter(ee.Filter.eq('ADM1_NAME', 'Sindh'));
var aoi = globals.gaul_l2.filter(ee.Filter.eq('ADM2_NAME', 'Bhakkar District'));
var clippedCumulativeFlooded = cumulativeFlooded.clip(aoi);
var clippedHRSL = HRSL_30m.mean().clip(aoi);
var vulnerabilityIndex = clippedHRSL.multiply(clippedCumulativeFlooded);



// Map.addLayer(aoi, {opacity: 0.1})
// Call like the below two lines (uncomment first)
vulnerability_index_chart(aoi)
mapVulnerabilityIndex(aoi)

exports.mapVulnerabilityIndex = mapVulnerabilityIndex;
exports.vulnerability_index_chart = vulnerability_index_chart;